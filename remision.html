<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RemisiÃ³n de Entrega</title>

<style>
*{box-sizing:border-box}
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:0;padding:15px}
.container{max-width:600px;margin:auto;background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.encabezado{text-align:center;margin-bottom:12px}
.encabezado img{max-width:280px;max-height:120px;object-fit:contain}
.folio{font-size:14px;font-weight:bold;margin-top:6px}
.estado{font-size:13px;color:#e67e22;margin-top:4px}
h2{text-align:center;margin-top:6px}
label{font-weight:bold;display:block;margin-top:14px}
input,select,textarea,button{
  width:100%;padding:12px;margin-top:6px;
  border-radius:8px;border:1px solid #ccc;font-size:15px
}
textarea{resize:vertical}
button{background:#4ca494;color:#fff;border:none;cursor:pointer}
.producto{border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:10px}
.firma-box{border:2px dashed #aaa;border-radius:8px;margin-top:10px}
canvas{width:100%;height:180px}
.bienvenida{text-align:center;font-weight:bold}
.footer-agente{text-align:center;font-size:12px;color:#999;margin-top:20px}
.actions{display:flex;gap:10px;margin-top:10px}
.actions button{flex:1}
.eliminar{background:#e74c3c;font-size:14px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.preview{display:flex;flex-wrap:wrap}
.preview img{width:80px;margin:6px;border-radius:6px;border:1px solid #ccc}
</style>
</head>

<body>

<script>
/* =========================
   PROTECCIÃ“N + REDIRECCIÃ“N
========================= */
const usuario = JSON.parse(localStorage.getItem("usuario"));
if (!usuario || !usuario.usuario || !usuario.rol) {
  window.location.href = "index.html";
}

const pendientes = JSON.parse(localStorage.getItem("pendientes")) || [];
const params = new URLSearchParams(window.location.search);

if (pendientes.length > 0 && !params.get("folio")) {
  window.location.href = "pendientes.html";
}

</script>

<div class="container">

  <div class="encabezado">
    <img id="logoEmpresa">
    <div class="folio" id="folio"></div>
    <div class="estado">Estado: Pendiente</div>
  </div>

  <div class="bienvenida" id="bienvenida"></div>
  <h2>RemisiÃ³n de Entrega</h2>

  <label>Empresa</label>
  <select id="empresa">
    <option value="empresa1">Galprom</option>
    <option value="empresa2">Dicomete</option>
    <option value="empresa3">Metahnos</option>
  </select>

  <label>Horario de entrega</label>
  <div class="grid-2">
    <select id="horaInicio"></select>
    <select id="horaFin"></select>
  </div>

  <label>Cliente</label>
  <input id="cliente" list="listaClientes">
  <datalist id="listaClientes"></datalist>

  <label>Correo</label>
  <input type="email" id="correo">

  <label>DirecciÃ³n</label>
  <textarea id="direccion" rows="3"></textarea>

  <label>Productos</label>
  <div id="productos"></div>
  <button onclick="agregarProducto()">âž• Agregar producto</button>

  <label>Fotos de evidencia</label>
  <input type="file" accept="image/*" multiple capture="environment" onchange="cargarFotos(this)">
  <div class="preview" id="previewFotos"></div>

  <label>Firma del cliente</label>
  <div class="firma-box">
    <canvas id="firma"></canvas>
  </div>

  <div class="actions">
    <button onclick="limpiarFirma()">Limpiar firma</button>
  </div>

  <div class="actions">
    <button onclick="cerrarEntrega()">Cerrar entrega</button>
    <button onclick="guardarPendiente()" style="background:#f39c12">Guardar pendiente</button>
  </div>

  <div class="actions">
    <button onclick="verPendientes()" style="background:#6b8cbc">
      ðŸ“‹ Ver remisiones pendientes
    </button>
  </div>

  <div class="footer-agente" id="footerAgente"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw_kfK5xUfLG2XcmyCGe0fc5EffIiH1OidxmJ-GrZVR1B5qvdU9gAIxKTLR8N8RKZrU/exec";

bienvenida.innerText = "Buen dÃ­a, " + usuario.usuario;
footerAgente.innerText = "Elaborado por: " + usuario.usuario;

/* =========================
   EMPRESAS
========================= */
const empresas = {
  empresa1:{logo:"logos/empresa1.png"},
  empresa2:{logo:"logos/empresa2.png"},
  empresa3:{logo:"logos/empresa3.png"}
};
empresa.onchange = () => logoEmpresa.src = empresas[empresa.value].logo;
empresa.onchange();

/* =========================
   HORAS
========================= */
function cargarHoras(){
  for(let h=6;h<=22;h++){
    ["00","30"].forEach(m=>{
      const v = String(h).padStart(2,"0")+":"+m;
      horaInicio.innerHTML += `<option>${v}</option>`;
      horaFin.innerHTML += `<option>${v}</option>`;
    });
  }
}
cargarHoras();

/* =========================
   CLIENTES (LOCAL)
========================= */
let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
function cargarClientes(){
  listaClientes.innerHTML="";
  clientes.forEach(c=>{
    listaClientes.innerHTML+=`<option value="${c.nombre}">`;
  });
}
cliente.onchange=()=>{
  const c = clientes.find(x=>x.nombre===cliente.value);
  if(c){ correo.value=c.correo; direccion.value=c.direccion; }
};
cargarClientes();

/* =========================
   FOLIO
========================= */
let folioLocal = localStorage.getItem("folioLocal") || "TMP-" + Date.now();
localStorage.setItem("folioLocal", folioLocal);
folio.innerText = "Folio: " + folioLocal;

/* =========================
   FIRMA
========================= */
const canvas=document.getElementById("firma");
const ctx=canvas.getContext("2d");
canvas.width=canvas.offsetWidth;canvas.height=180;
let draw=false;
canvas.addEventListener("touchstart",()=>draw=true);
canvas.addEventListener("touchend",()=>{draw=false;ctx.beginPath()});
canvas.addEventListener("touchmove",e=>{
  if(!draw)return;
  const r=canvas.getBoundingClientRect(),t=e.touches[0];
  ctx.lineWidth=2;ctx.lineCap="round";
  ctx.lineTo(t.clientX-r.left,t.clientY-r.top);
  ctx.stroke();ctx.beginPath();
  ctx.moveTo(t.clientX-r.left,t.clientY-r.top);
  e.preventDefault();
});
function limpiarFirma(){ctx.clearRect(0,0,canvas.width,canvas.height);}

/* =========================
   FOTOS
========================= */
let fotos=[];
function cargarFotos(input){
  [...input.files].forEach(f=>{
    const r=new FileReader();
    r.onload=e=>{
      fotos.push(e.target.result);
      previewFotos.innerHTML+=`<img src="${e.target.result}">`;
    };
    r.readAsDataURL(f);
  });
}

/* =========================
   PRODUCTOS
========================= */
function agregarProducto(){
  productos.innerHTML+=`
  <div class="producto">
    <input placeholder="Producto">
    <input type="number" placeholder="Cantidad">
    <input placeholder="Observaciones">
    <button class="eliminar" onclick="this.parentNode.remove()">Eliminar</button>
  </div>`;
}
agregarProducto();

/* =========================
   PENDIENTES
========================= */
function guardarPendiente(){
  let p=JSON.parse(localStorage.getItem("pendientes"))||[];
  p=p.filter(x=>x.folio!==folioLocal);
  p.push({folio:folioLocal,empresa:empresa.value,cliente:cliente.value,correo:correo.value,direccion:direccion.value,productos:[],usuario});
  localStorage.setItem("pendientes",JSON.stringify(p));
  alert("Guardado como pendiente");
}
function verPendientes(){
  let p=JSON.parse(localStorage.getItem("pendientes"))||[];
  if(!p.length)return alert("No hay pendientes");
  location.href="pendientes.html";
}

/* =========================
   ENVIAR
========================= */
async function cerrarEntrega(){
  await fetch(SCRIPT_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"guardarRemision",
      remision:{
        empresa:empresa.value,
        cliente:cliente.value,
        correo:correo.value,
        direccion:direccion.value,
        horario:{inicio:horaInicio.value,fin:horaFin.value},
        usuario,
        productos:[...document.querySelectorAll(".producto")].map(p=>({
          nombre:p.children[0].value,
          cantidad:p.children[1].value
        })),
        firma:canvas.toDataURL(),
        fotos,
        estado:"entregada"
      }
    })
  });
  localStorage.removeItem("folioLocal");
  location.reload();
}
</script>

</body>
</html>


